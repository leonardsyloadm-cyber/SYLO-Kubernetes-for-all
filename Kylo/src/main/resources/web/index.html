<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>KyloDB v27 (Insert Fix Final)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --dark: #2c3e50; --accent: #3498db; --light: #ecf0f1; --danger: #e74c3c; --success: #2ecc71; --console: #1e272e; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; background: #f8f9fa; color: #333; font-size: 13px; }
        
        /* SIDEBAR */
        .sidebar { width: 280px; background: #2f3640; color: #dcdde1; display: flex; flex-direction: column; flex-shrink: 0; user-select: none; }
        .logo { padding: 18px; font-size: 1.2em; font-weight: 800; background: #242a30; border-bottom: 1px solid #353b48; display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--accent); }
        .tree-area { flex: 1; overflow-y: auto; padding: 10px 0; }
        
        .node-row { display: flex; align-items: center; padding: 6px 15px; cursor: pointer; border-left: 3px solid transparent; transition:0.2s; }
        .node-row:hover { background: #353b48; color: white; }
        .node-row.active { background: #353b48; border-left-color: var(--accent); color: white; }
        .toggle-icon { width: 20px; text-align: center; color: #7f8fa6; font-size: 0.8em; }
        .ic-db { color: #f1c40f; } .ic-tbl { color: #00d2d3; } .ic-col { color: #2ecc71; font-size: 0.9em; }
        .node-sub { padding-left: 35px; } .node-sub-sub { padding-left: 60px; font-size: 0.9em; color: #a4b0be; }
        
        /* MAIN */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .topbar { background: white; padding: 0 20px; height: 50px; display: flex; align-items: center; border-bottom: 1px solid #ddd; }
        .tabs { background: white; display: flex; padding: 0 20px; border-bottom: 1px solid #ddd; gap: 20px; }
        .tab { padding: 12px 0; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #7f8fa6; }
        .tab.active { border-bottom-color: var(--accent); color: var(--accent); }
        .content { padding: 20px; overflow-y: auto; flex: 1; position: relative; }
        .panel { display: none; animation: fadeIn 0.3s; } .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* VISUAL STRUCTURE */
        .org-container { display: flex; flex-direction: column; align-items: center; padding: 40px; }
        .org-db { background: #2c3e50; color: white; padding: 10px 30px; border-radius: 50px; font-weight: 800; font-size: 1.4em; position: relative; margin-bottom: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 2; }
        .org-db::after { content: ''; position: absolute; bottom: -40px; left: 50%; width: 2px; height: 40px; background: #bdc3c7; }
        .org-tables-row { display: flex; gap: 40px; position: relative; justify-content: center; padding-top: 20px; }
        .org-tables-row::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: #bdc3c7; margin-left: calc(50% / var(--child-count)); margin-right: calc(50% / var(--child-count)); }
        .org-tables-row::after { content: ''; position: absolute; top: -20px; left: 50%; width: 2px; height: 20px; background: #bdc3c7; }
        .org-table-group { display: flex; flex-direction: column; align-items: center; position: relative; }
        .org-table-group::before { content: ''; position: absolute; top: -22px; left: 50%; width: 2px; height: 22px; background: #bdc3c7; }
        .org-table-card { background: var(--accent); color: white; padding: 8px 20px; border-radius: 6px; font-weight: bold; font-size: 1.1em; margin-bottom: 20px; position: relative; box-shadow: 0 4px 8px rgba(52,152,219,0.3); min-width: 120px; text-align: center; }
        .org-table-card::after { content: ''; position: absolute; bottom: -20px; left: 50%; width: 2px; height: 20px; background: #bdc3c7; }
        .org-cols-container { display: flex; flex-direction: column; gap: 8px; position: relative; }
        .org-cols-container::before { content: ''; position: absolute; top: -20px; bottom: 15px; left: 50%; width: 2px; background: #bdc3c7; margin-left: -1px; z-index: 0; }
        .org-col-card { background: white; border: 1px solid #ddd; padding: 6px 12px; border-radius: 4px; text-align: center; width: 140px; position: relative; z-index: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .org-col-name { font-weight: bold; color: #34495e; font-size: 0.9em; }
        .org-col-type { font-size: 0.7em; color: #7f8fa6; background: #f1f2f6; padding: 2px 5px; border-radius: 3px; }

        /* KYLOQUERY */
        .kylo-layout { display: flex; gap: 20px; height: 100%; }
        .sql-col { flex: 1; display: flex; flex-direction: column; gap: 10px; position: relative; }
        .cheat-col { width: 300px; background: white; border: 1px solid #ccc; border-radius: 4px; display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        
        /* BUILDER */
        #builder-panel { background: #f8f9fa; border: 1px solid #ddd; padding: 15px; border-radius: 6px; margin-bottom: 10px; display: none; }
        .builder-row { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; min-height: 50px; }
        
        .b-block { padding: 10px 15px; border-radius: 4px; color: white; font-weight: bold; cursor: grab; display: flex; align-items: center; gap: 8px; font-size: 0.95em; box-shadow: 0 2px 5px rgba(0,0,0,0.1); user-select: none; transition: 0.1s; border: 2px solid transparent; }
        .b-block:active { cursor: grabbing; transform: scale(1.01); }
        .b-block.dragging { opacity: 0.4; }
        
        .b-block.drag-over-top { border-top: 4px solid #3498db; margin-top: 5px; }
        .b-block.drag-over-bottom { border-bottom: 4px solid #3498db; margin-bottom: 5px; }

        .b-head { background: #2c3e50; cursor: default; } 
        .b-from { background: #e67e22; } .b-where { background: #9b59b6; } .b-order { background: #1abc9c; }
        .b-into { background: #e67e22; } .b-values { background: #27ae60; } .b-set { background: #f39c12; }
        .b-create { background: #8e44ad; } .b-col { background: #2980b9; } 
        .b-pk { background: #e74c3c; font-size: 0.8em; padding: 4px 8px; }
        .b-uk { background: #f39c12; font-size: 0.8em; padding: 4px 8px; }
        .b-fk { background: #34495e; padding: 5px 12px; }
        .b-field { background: #16a085; }
        
        .b-input { background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 3px; width: 120px; font-size: 0.9em; }
        .b-input::placeholder { color: rgba(255,255,255,0.6); }
        .b-input:focus { outline: none; background: rgba(255,255,255,0.3); }
        
        .b-sel-type, .b-sel-tbl, .b-sel-col, .b-sel-op { background: rgba(0,0,0,0.2); color: white; border: none; font-size: 0.9em; border-radius: 3px; cursor: pointer; padding: 4px; }
        .b-sel-type option, .b-sel-tbl option, .b-sel-col option, .b-sel-op option { background: #333; }
        .b-sel-op { width: 50px; text-align: center; background: rgba(0,0,0,0.4); }

        .mode-btn { background: white; border: 1px solid #ccc; color: #555; padding: 4px 10px; font-size: 0.8em; border-radius: 15px; cursor: pointer; transition: 0.2s; }
        .mode-btn:hover { background: #eee; }
        .mode-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .console { background: var(--console); color: #2ecc71; padding: 15px; font-family: monospace; height: 150px; overflow-y: auto; border-radius: 4px; border: 1px solid #000; font-size:0.9em; margin-bottom: 20px; }
        #sql-result-container { border: 1px solid #3498db; border-radius: 4px; display: none; background: white; overflow: hidden; margin-bottom: 20px; }
        #sql-result-header { background: #3498db; color: white; padding: 8px 15px; font-weight: bold; display: flex; justify-content: space-between; }
        #sql-result-area { max-height: 300px; overflow-y: auto; padding: 0; }

        .cheat-list { overflow-y: auto; flex: 1; }
        .cheat-grp { background: #f1f2f6; padding: 8px 15px; font-weight: bold; font-size: 0.85em; color: #2c3e50; border: 1px solid #ddd; border-width: 1px 0; }
        .cheat-item { padding: 6px 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; color: #2980b9; font-family: monospace; font-size: 0.9em; }
        .cheat-item:hover { background: #eef7ff; }

        .btn { padding: 8px 15px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition:0.2s; }
        .btn:hover { opacity:0.9; } .btn-red { background: var(--danger); } .btn-green { background: var(--success); }
        table.grid { width: 100%; border-collapse: collapse; background: white; }
        table.grid th { background: #f1f2f6; padding: 10px; text-align: left; position: sticky; top: 0; border-bottom: 2px solid #ddd; }
        table.grid td { padding: 8px; border-bottom: 1px solid #eee; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px; border-radius: 4px; display: none; z-index: 999; }
        .suggestion-box { position: absolute; background: white; border: 1px solid #ccc; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 4px; width: 200px; display: none; z-index: 100; max-height: 150px; overflow-y: auto; }
        .sug-item { padding: 8px 15px; cursor: pointer; border-bottom: 1px solid #f1f1f1; display: flex; align-items: center; gap: 8px; }
        .sug-item:hover { background: #f1f2f6; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo"><i class="fas fa-layer-group"></i> KYLO<span style="font-weight:300">ARCHITECT</span></div>
    <div style="padding:15px"><button class="btn btn-green" style="width:100%" onclick="newDB()">+ Nueva DB</button></div>
    <div class="tree-area" id="tree-root"></div>
</div>

<div class="main">
    <div class="topbar">
        <div><i class="fas fa-database" style="color:#f1c40f"></i> <b id="lbl-db">...</b> <i class="fas fa-chevron-right" style="color:#ccc"></i> <b id="lbl-tbl">...</b></div>
    </div>
    <div class="tabs">
        <div class="tab active" onclick="nav('browse')">Examinar</div>
        <div class="tab" onclick="nav('struct')">Estructura Visual</div>
        <div class="tab" onclick="nav('sql')">KyloQuery AI</div>
        <div class="tab" onclick="nav('insert')">Insertar</div>
    </div>
    
    <div class="content">
        <div id="p-browse" class="panel active">
            <div style="margin-bottom:15px; display:flex; justify-content:space-between">
                <h3>Datos de Tabla</h3>
                <div>
                    <button class="btn btn-red" onclick="truncateTbl()">Vaciar</button>
                    <button class="btn" onclick="refreshBrowse()">Refrescar</button>
                </div>
            </div>
            <div id="browse-grid"></div>
        </div>

        <div id="p-struct" class="panel">
            <div id="vis-area" class="org-container"><p style="color:#aaa">Selecciona una base de datos.</p></div>
        </div>

        <div id="p-sql" class="panel" style="height:100%">
            <div class="kylo-layout">
                <div class="sql-col">
                    <div style="margin-bottom:5px">
                        <button class="btn" style="background:#95a5a6; font-size:0.8em" onclick="toggleBuilder()"><i class="fas fa-magic"></i> Constructor Visual</button>
                        <button class="btn" style="background:#95a5a6; font-size:0.8em" onclick="clearHistory()"><i class="fas fa-trash"></i> Limpiar Historial</button>
                    </div>

                    <div id="builder-panel">
                        <div style="margin-bottom:10px; display:flex; gap:5px; flex-wrap:wrap">
                            <span class="mode-btn active" onclick="setMode('SELECT')">SELECT</span>
                            <span class="mode-btn" onclick="setMode('INSERT')">INSERT</span>
                            <span class="mode-btn" onclick="setMode('UPDATE')">UPDATE</span>
                            <span class="mode-btn" onclick="setMode('DELETE')">DELETE</span>
                            <span class="mode-btn" onclick="setMode('CREATE')" style="border-color:#8e44ad; color:#8e44ad; font-weight:bold">CREATE</span>
                        </div>
                        
                        <div class="builder-row" id="b-canvas">
                            <div class="b-block b-head">SELECT *</div>
                        </div>
                        
                        <div class="builder-row" style="border-top:1px solid #ddd; padding-top:10px; gap:5px; flex-direction:row" id="b-tools">
                            </div>
                    </div>

                    <textarea id="sql-in" style="height:120px; padding:15px; font-family:monospace; border:1px solid #ccc; font-size:1.1em; resize:none" placeholder="SQL..."></textarea>
                    <div id="sug-box" class="suggestion-box"></div>

                    <div style="text-align:right; margin-bottom:10px"><button class="btn" onclick="runSQL()">EJECUTAR</button></div>
                    
                    <div style="font-weight:bold; margin-bottom:5px; color:#555">Terminal Hist√≥rico:</div>
                    <div id="console" class="console"></div>

                    <div id="sql-result-container">
                        <div id="sql-result-header">
                            <span><i class="fas fa-table"></i> Resultados</span>
                            <span style="font-size:0.8em; opacity:0.8" id="res-count">0 filas</span>
                        </div>
                        <div id="sql-result-area"></div>
                    </div>
                </div>
                
                <div class="cheat-col">
                    <div style="padding:10px; font-weight:bold; text-align:center; background:#eee">COMANDOS</div>
                    <div class="cheat-list">
                        <div class="cheat-grp">DDL</div>
                        <div class="cheat-item" onclick="fill('CREATE TABLE t (id INT PK)')">CREATE TABLE</div>
                        <div class="cheat-item" onclick="fill('ALTER TABLE t ADD COLUMN c TEXT')">ALTER TABLE</div>
                        <div class="cheat-item" onclick="fill('DROP TABLE t')">DROP TABLE</div>
                        <div class="cheat-grp">DML</div>
                        <div class="cheat-item" onclick="fill('SELECT * FROM t')">SELECT *</div>
                        <div class="cheat-item" onclick="fill('INSERT INTO t VALUES (1, \'a\')')">INSERT</div>
                        <div class="cheat-item" onclick="fill('UPDATE t SET {} WHERE _ID=\'x\'')">UPDATE</div>
                        <div class="cheat-grp">Advanced</div>
                        <div class="cheat-item" onclick="fill('BACKUP DATABASE db')">BACKUP</div>
                        <div class="cheat-item" onclick="fill('OPTIMIZE TABLE t')">OPTIMIZE</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="p-insert" class="panel">
            <h3>Nuevo Registro</h3>
            <div id="insert-form" style="background:white; padding:20px; border:1px solid #ccc; max-width:500px"></div>
        </div>
    </div>
</div>
<div id="toast" class="toast"></div>

<script>
    let activeDB='', activeTbl='', tablesInDB=[], currentMode='SELECT', fullCatalog={};

    async function loadTree() {
        const r = await fetch('/api/catalog'); const tree = await r.json(); fullCatalog = tree;
        if(activeDB && fullCatalog[activeDB]) { tablesInDB = Object.keys(fullCatalog[activeDB]); }
        const root = document.getElementById('tree-root');
        root.innerHTML = '<ul style="list-style:none; padding:0; margin:0">';
        for(const [db, tables] of Object.entries(tree)) {
            let html = `<li><div class="node-row ${activeDB===db?'active':''}"><div class="toggle-icon" onclick="toggleSub(this)"><i class="fas fa-plus-square"></i></div><div style="flex:1" onclick="selectDB('${db}')"><i class="fas fa-database ic-db"></i> ${db}</div></div><ul style="display:none; list-style:none; padding:0;">`;
            for(const [tbl, cols] of Object.entries(tables)) {
                html += `<li><div class="node-row node-sub ${activeTbl===tbl && activeDB===db?'active':''}"><div class="toggle-icon" onclick="toggleSub(this)"><i class="fas fa-plus-square"></i></div><div style="flex:1" onclick="selectTable('${db}','${tbl}')"><i class="fas fa-table ic-tbl"></i> ${tbl}</div></div><ul style="display:none; list-style:none; padding:0;">`;
                cols.forEach(c => html += `<li><div class="node-row node-sub-sub"><i class="fas fa-columns ic-col"></i> ${c.split(':')[0]}</div></li>`);
                html += `</ul></li>`;
            } html += `</ul></li>`; root.innerHTML += html;
        } root.innerHTML += '</ul>';
    }

    function selectDB(db) { activeDB=db; activeTbl=''; document.getElementById('lbl-db').innerText=db; fetch('/api/catalog').then(r=>r.json()).then(d => { fullCatalog=d; tablesInDB=Object.keys(d[db]||{}); }); execSQL(`USE ${db}`, true); nav('struct'); loadStruct(); }

    // --- BUILDER & DRAG/DROP VISUAL ---
    let dragSrc = null;

    function setMode(m) {
        currentMode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-btn').forEach(b => { if(b.innerText===m) b.classList.add('active'); });
        
        const canvas = document.getElementById('b-canvas');
        const tools = document.getElementById('b-tools');
        canvas.innerHTML = '';
        
        if(m==='SELECT') {
            canvas.innerHTML = '<div class="b-block b-head">SELECT *</div>';
            tools.innerHTML = `<button class="btn b-from" onclick="addBlock('FROM')">+ FROM</button> <button class="btn b-where" onclick="addBlock('WHERE')">+ WHERE</button> <button class="btn b-order" onclick="addBlock('ORDER')">+ ORDER</button>`;
        } else if(m==='INSERT') {
            canvas.innerHTML = '<div class="b-block b-head">INSERT</div>';
            // IMPORTANTE: Aseguramos que cargamos las tablas antes
            tools.innerHTML = `<button class="btn b-into" onclick="addBlock('INTO')">+ INTO (Tabla)</button> <button class="btn b-values" onclick="addBlock('FIELD')">+ CAMPO=VALOR</button>`;
        } else if(m==='UPDATE') {
            canvas.innerHTML = '<div class="b-block b-head">UPDATE</div>';
            tools.innerHTML = `<button class="btn b-from" onclick="addBlock('TABLE')">+ TABLE</button> <button class="btn b-set" onclick="addBlock('SET')">+ SET (Col=Val)</button> <button class="btn b-where" onclick="addBlock('WHERE')">+ WHERE</button>`;
        } else if(m==='DELETE') {
            canvas.innerHTML = '<div class="b-block b-head">DELETE</div>';
            tools.innerHTML = `<button class="btn b-from" onclick="addBlock('FROM')">+ FROM</button> <button class="btn b-where" onclick="addBlock('WHERE')">+ WHERE</button>`;
        } else if(m==='CREATE') { 
            canvas.innerHTML = '<div class="b-block b-create">CREATE TABLE <input class="b-input" style="width:80px" placeholder="nombre" oninput="updB()"></div>';
            tools.innerHTML = `<button class="btn b-col" onclick="addBlock('COLUMN')">+ COLUMNA</button> <button class="btn b-pk" onclick="addBlock('PK')">+ PK</button> <button class="btn b-uk" onclick="addBlock('UK')">+ UK</button> <button class="btn b-fk" onclick="addBlock('FK')">+ FK</button>`;
        }
        tools.innerHTML += `<button class="btn btn-red" style="margin-left:auto" onclick="resetBuilder()">Reset</button>`;
        updB();
    }

    function addBlock(t) {
        let cls = 'b-select'; let content = '';
        
        // --- FIX DEL SELECTOR ---
        if(t==='INTO') {
            cls = 'b-into'; 
            // Generamos las opciones aqui mismo
            let tblOpts = tablesInDB.length > 0 ? tablesInDB.map(tt => `<option value="${tt}">${tt}</option>`).join('') : '<option disabled>Sin tablas</option>';
            content = `${t} <select class="b-sel-tbl" onchange="updateContext(this)">${tblOpts}</select>`;
        }
        // Resto de bloques
        else if(t==='FROM' || t==='TABLE') {
            cls = 'b-from';
            let tblOpts = tablesInDB.length > 0 ? tablesInDB.map(tt => `<option value="${tt}">${tt}</option>`).join('') : '<option disabled>Sin tablas</option>';
            content = `${t} <select class="b-sel-tbl" onchange="updateContext(this)">${tblOpts}</select>`;
        }
        else if(t==='WHERE') {
            cls = 'b-where';
            let colOpts = getColOpts(getActiveTableInBuilder());
            content = `WHERE <select class="b-sel-col" onchange="updB()">${colOpts}</select> <select class="b-sel-op" onchange="updB()"><option>=</option><option>!=</option><option>&gt;</option><option>&lt;</option><option>LIKE</option></select> <input class="b-input" oninput="updB()">`;
        }
        else if(t==='ORDER') {
            cls = 'b-order';
            let colOpts = getColOpts(getActiveTableInBuilder());
            content = `ORDER BY <select class="b-sel-col" onchange="updB()">${colOpts}</select> <select class="b-sel-op" onchange="updB()"><option>ASC</option><option>DESC</option></select>`;
        }
        else if(t==='FIELD') {
            cls = 'b-field';
            let colOpts = getColOpts(getActiveTableInBuilder());
            content = `SET <select class="b-sel-col" onchange="updB()">${colOpts}</select> = <input class="b-input" placeholder="valor" oninput="updB()">`;
        }
        else if(t==='SET') {
            cls = 'b-set';
            let colOpts = getColOpts(getActiveTableInBuilder());
            content = `SET <select class="b-sel-col" onchange="updB()">${colOpts}</select> = <input class="b-input" placeholder="valor" oninput="updB()">`;
        }
        else if(t==='PK') { cls='b-pk'; content='PRIMARY KEY'; }
        else if(t==='UK') { cls='b-uk'; content='UNIQUE'; }
        else if(t==='COLUMN') { 
            cls = 'b-col';
            content = `COL <input class="b-input" style="width:70px" placeholder="nombre" oninput="updB()"> <select class="b-sel-type" onchange="updB()"><option>INT</option><option>TEXT</option><option>EMAIL</option><option>DATE</option></select>`;
        } else if(t==='FK') { 
            cls = 'b-fk';
            let tblOpts = tablesInDB.map(tt => `<option value="${tt}">${tt}</option>`).join('');
            content = `FK (<input class="b-input" style="width:50px" placeholder="local" oninput="updB()">) REFS <select class="b-sel-tbl" onchange="updateFkCols(this)">${tblOpts}</select> (<select class="b-sel-col" onchange="updB()"></select>)`;
        } else {
            content = `${t} <input class="b-input" oninput="updB()">`;
        }
        
        const div = document.createElement('div');
        div.className = `b-block ${cls}`;
        div.draggable = true;
        div.innerHTML = content;
        div.addEventListener('dragstart', handleDragStart);
        div.addEventListener('dragover', handleDragOver);
        div.addEventListener('dragleave', handleDragLeave);
        div.addEventListener('drop', handleDrop);
        div.addEventListener('dragend', handleDragEnd);
        
        document.getElementById('b-canvas').appendChild(div);
        if(t==='FK') updateFkCols(div.querySelector('.b-sel-tbl'));
        updB();
    }

    // --- DRAG INDICATORS ---
    function handleDragStart(e) { dragSrc = this; e.dataTransfer.effectAllowed = 'move'; this.classList.add('dragging'); }
    function handleDragOver(e) { 
        if (e.preventDefault) e.preventDefault(); 
        const bounding = this.getBoundingClientRect();
        const offset = e.clientY - bounding.top;
        this.classList.remove('drag-over-top', 'drag-over-bottom'); 
        if (offset > bounding.height / 2) this.classList.add('drag-over-bottom'); else this.classList.add('drag-over-top');
        return false; 
    }
    function handleDragLeave(e) { this.classList.remove('drag-over-top', 'drag-over-bottom'); }
    function handleDragEnd(e) { document.querySelectorAll('.b-block').forEach(b => b.classList.remove('drag-over-top', 'drag-over-bottom', 'dragging')); }
    function handleDrop(e) {
        e.stopPropagation();
        this.classList.remove('drag-over-top', 'drag-over-bottom');
        if (dragSrc !== this) {
            const bounding = this.getBoundingClientRect();
            const offset = e.clientY - bounding.top;
            if (offset > bounding.height / 2) this.parentNode.insertBefore(dragSrc, this.nextSibling); else this.parentNode.insertBefore(dragSrc, this);
            updB();
        }
        return false;
    }

    // --- INTELLIGENCE ---
    function getActiveTableInBuilder() { const s = document.querySelector('.b-sel-tbl'); return s ? s.value : (tablesInDB[0] || ''); }
    function getColOpts(tbl) { if(tbl&&fullCatalog[activeDB]&&fullCatalog[activeDB][tbl]) return fullCatalog[activeDB][tbl].map(c=>`<option value="${c.split(':')[0]}">${c.split(':')[0]}</option>`).join(''); return '<option>id</option>'; }
    function updateContext(sel) { updB(); const t=sel.value; const n=getColOpts(t); document.querySelectorAll('.b-sel-col').forEach(s=>s.innerHTML=n); }
    function updateFkCols(s) { const t=s.value; const n=s.nextElementSibling; if(fullCatalog[activeDB]&&fullCatalog[activeDB][t]) n.innerHTML=fullCatalog[activeDB][t].map(c=>`<option value="${c.split(':')[0]}">${c.split(':')[0]}</option>`).join(''); else n.innerHTML=""; updB(); }

    function updB() {
        let s = ""; const blocks = document.querySelectorAll('.b-block');
        if(currentMode==='SELECT') { 
            s = "SELECT *"; 
            blocks.forEach(el => { 
                if(el.classList.contains('b-head'))return; 
                if(el.classList.contains('b-where')) { const c=el.querySelector('.b-sel-col').value; const o=el.querySelector('.b-sel-op').value; const v=el.querySelector('input').value; if(v)s+=` WHERE ${c} ${o} ${v}`; }
                else if(el.classList.contains('b-order')) { const c=el.querySelector('.b-sel-col').value; const o=el.querySelector('.b-sel-op').value; s+=` ORDER BY ${c} ${o}`; }
                else if(el.classList.contains('b-from')) { s+=` FROM ${el.querySelector('select').value}`; } 
                else s+=` ${el.innerText.split(' ')[0]} ${el.querySelector('input').value}`; 
            }); 
        }
        else if(currentMode==='INSERT') { 
            let tbl = ""; let cols = []; let vals = [];
            blocks.forEach(el => { 
                if(el.classList.contains('b-into')) tbl = el.querySelector('select').value;
                if(el.classList.contains('b-field')) { cols.push(el.querySelector('.b-sel-col').value); vals.push(el.querySelector('input').value); }
            }); 
            if(tbl && cols.length) s = `INSERT INTO ${tbl} (${cols.join(', ')}) VALUES (${vals.join(', ')})`;
            else s = "INSERT INTO ...";
        }
        else if(currentMode==='UPDATE') { 
            s="UPDATE"; let sets=[];
            blocks.forEach(el=>{ 
                if(el.classList.contains('b-head'))return; 
                if(el.classList.contains('b-from')) s+=` ${el.querySelector('select').value}`; 
                else if(el.classList.contains('b-set')){ const c=el.querySelector('.b-sel-col').value; const v=el.querySelector('input').value; if(v)sets.push(`${c}=${v}`); }
                else if(el.classList.contains('b-where')){const c=el.querySelector('.b-sel-col').value;const o=el.querySelector('.b-sel-op').value;const v=el.querySelector('input').value;if(v)s+=` SET ${sets.join(', ')} WHERE ${c} ${o} ${v}`;} 
            }); 
            if(!s.includes('WHERE') && sets.length) s+=` SET ${sets.join(', ')}`;
        }
        else if(currentMode==='DELETE') { s="DELETE"; blocks.forEach(el=>{ if(el.classList.contains('b-head'))return; if(el.classList.contains('b-from'))s+=` FROM ${el.querySelector('select').value}`; else if(el.classList.contains('b-where')){const c=el.querySelector('.b-sel-col').value;const o=el.querySelector('.b-sel-op').value;const v=el.querySelector('input').value;if(v)s+=` WHERE ${c} ${o} ${v}`;} }); }
        else if(currentMode==='CREATE') {
            const tName = blocks[0].querySelector('input').value || 'nueva_tabla'; s = `CREATE TABLE ${tName} (`; let defs = [];
            blocks.forEach((el, idx) => {
                if(idx===0) return;
                if(el.classList.contains('b-col')) { const n=el.querySelector('input').value; const t=el.querySelector('select').value; if(n) defs.push(`${n} ${t}`); }
                else if(el.innerText.includes('PRIMARY KEY') && defs.length) defs[defs.length-1] += " PRIMARY KEY";
                else if(el.innerText.includes('UNIQUE') && defs.length) defs[defs.length-1] += " UNIQUE";
                else if(el.classList.contains('b-fk')) { const l=el.querySelector('input').value; const rt=el.querySelector('.b-sel-tbl').value; const rc=el.querySelector('.b-sel-col').value; if(l&&rt&&rc) defs.push(`FOREIGN KEY (${l}) REFERENCES ${rt}(${rc})`); }
            }); s += defs.join(', ') + ")";
        }
        document.getElementById('sql-in').value = s;
    }
    
    // --- UTILS ---
    function toggleBuilder(){ const b=document.getElementById('builder-panel'); b.style.display=b.style.display==='none'?'block':'none'; setMode('SELECT'); }
    function resetBuilder() { setMode(currentMode); document.getElementById('sql-in').value=''; }
    document.getElementById('sql-in').addEventListener('input', function() {
        const val=this.value; const last=val.substring(0,this.selectionStart).split(/\s+/).slice(-2,-1)[0]; const box=document.getElementById('sug-box');
        if(last && (['FROM','INTO','UPDATE'].includes(last.toUpperCase())) && tablesInDB.length>0) {
            const m=tablesInDB.filter(t=>t.toLowerCase().startsWith(val.split(/\s+/).pop().toLowerCase()));
            if(m.length){ box.innerHTML=m.map(t=>`<div class="sug-item" onclick="insSug('${t}')"><i class="fas fa-table"></i> ${t}</div>`).join(''); box.style.display='block'; box.style.top=(this.offsetTop+40)+'px'; box.style.left=(this.offsetLeft+20)+'px'; return; }
        } box.style.display='none';
    });
    function insSug(t){ const v=document.getElementById('sql-in'); v.value=v.value.replace(/\S+$/, t); document.getElementById('sug-box').style.display='none'; v.focus(); }
    function loadHistory(){ JSON.parse(localStorage.getItem('kh')||'[]').forEach(c=>log(`> ${c}`)); }
    function addToHistory(c){ let h=JSON.parse(localStorage.getItem('kh')||'[]'); h.push(c); if(h.length>50)h.shift(); localStorage.setItem('kh',JSON.stringify(h)); log(`> ${c}`); }
    function clearHistory(){ localStorage.removeItem('kh'); document.getElementById('console').innerHTML=''; }
    function selectTable(db,tbl){ activeDB=db; activeTbl=tbl; document.getElementById('lbl-db').innerText=db; document.getElementById('lbl-tbl').innerText=tbl; execSQL(`USE ${db}`, true); nav('browse'); refreshBrowse(); }
    function toggleSub(el){ const u=el.parentElement.nextElementSibling; u.style.display=u.style.display==='none'?'block':'none'; el.innerHTML=u.style.display==='none'?'<i class="fas fa-plus-square"></i>':'<i class="fas fa-minus-square"></i>'; }
    async function loadStruct(){ if(!activeDB)return; const r=await fetch('/api/catalog'); const t=await r.json(); const d=t[activeDB]||{}; const a=document.getElementById('vis-area'); let h=`<div class="org-db">${activeDB}</div><div class="org-tables-row" style="--child-count:${Object.keys(d).length}">`; for(const[k,v]of Object.entries(d)){h+=`<div class="org-table-group"><div class="org-table-card">${k}</div><div class="org-cols-container">`; v.forEach(c=>{h+=`<div class="org-col-card"><span class="org-col-name">${c.split(':')[0]}</span><span class="org-col-type">${c.split(':')[1]}</span></div>`;}); h+='</div></div>';} h+='</div>'; a.innerHTML=h; }
    async function refreshBrowse(){ if(!activeTbl)return; const r=await fetch('/api/query',{method:'POST',body:`SELECT * FROM ${activeTbl}`}); const d=await r.json(); const div=document.getElementById('browse-grid'); div.innerHTML=''; if(!d.data||!d.data.length){div.innerHTML='Vacio';return;} const k=Object.keys(d.data[0]).filter(x=>x!=='_ID'); let h='<table class="grid"><thead><tr>'; k.forEach(x=>h+=`<th>${x}</th>`); h+='</tr></thead><tbody>'; d.data.forEach(r=>{h+='<tr>';k.forEach(c=>h+=`<td>${r[c]}</td>`);h+=`<td><button class="btn btn-red" style="padding:2px 6px" onclick="delRow('${r['_ID']}')">X</button></td></tr>`;}); h+='</tbody></table>'; div.innerHTML=h; }
    function nav(id){ document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active')); document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.getElementById('p-'+id).classList.add('active'); event.currentTarget.classList.add('active'); if(id==='struct')loadStruct(); if(id==='insert')buildInsert(); }
    function log(m){ const c=document.getElementById('console'); c.innerHTML+=`<div>${m}</div>`; c.scrollTop=c.scrollHeight; }
    function logResult(m,ok){ const c=document.getElementById('console'); c.innerHTML+=`<div style="color:${ok?'#2ecc71':'#e74c3c'}">${m}</div>`; c.scrollTop=c.scrollHeight; }
    function runSQL(){ execSQL(document.getElementById('sql-in').value); }
    function fill(t){ document.getElementById('sql-in').value=t; }
    function newDB(){ const n=prompt("Nombre:"); if(n) execSQL(`CREATE DATABASE ${n}`); }
    function toast(m){ const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
    async function delRow(id){ if(confirm('Borrar?')){ await execSQL(`DELETE FROM ${activeTbl} WHERE _ID='${id}'`); refreshBrowse(); }}
    async function truncateTbl(){ if(confirm('Vaciar?')){ await execSQL(`TRUNCATE ${activeTbl}`); refreshBrowse(); }}
    async function buildInsert(){ if(!activeTbl){document.getElementById('insert-form').innerHTML='Selecciona tabla.';return;} const r=await fetch(`/api/describe/${activeDB}/${activeTbl}`); const c=await r.json(); let h=''; c.forEach(col=>{ let t=col.type==='INT'?'number':'text'; h+=`<div style="margin-bottom:10px"><label style="font-weight:bold">${col.name}</label><input class="ins-val" type="${t}" style="width:100%; padding:8px; border:1px solid #ccc"></div>`; }); h+='<button class="btn" onclick="sendInsert()">Guardar</button>'; document.getElementById('insert-form').innerHTML=h; }
    async function sendInsert(){ let v=[]; document.querySelectorAll('.ins-val').forEach(i=>v.push(`'${i.value}'`)); await execSQL(`INSERT INTO ${activeTbl} VALUES (${v.join(',')})`); nav('browse'); refreshBrowse(); }
    async function execSQL(cmd, silent=false) { if(!silent) addToHistory(cmd); const r=await fetch('/api/query',{method:'POST',body:cmd}); const res=await r.json(); if(!silent){ logResult(res.success?`OK: ${res.message}`:`ERR: ${res.message}`,res.success); toast(res.message); if(cmd.includes('CREATE')||cmd.includes('DROP')) loadTree(); const resCont=document.getElementById('sql-result-container'); if(res.data&&res.data.length>0){ const k=Object.keys(res.data[0]).filter(x=>x!=='_ID'); let h='<table class="grid"><thead><tr>'; k.forEach(x=>h+=`<th>${x}</th>`); h+='</tr></thead><tbody>'; res.data.forEach(row=>{ h+='<tr>'; k.forEach(j=>h+=`<td>${row[j]}</td>`); h+='</tr>';}); h+='</tbody></table>'; document.getElementById('sql-result-area').innerHTML=h; document.getElementById('res-count').innerText=res.data.length+' filas'; resCont.style.display='block'; } else { resCont.style.display='none'; }}}

    loadTree(); loadHistory();
</script>
</body>
</html>